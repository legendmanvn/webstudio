jQuery.template("operator-status-switcher-options-tmpl",'<ul class="dropdown-content "><li id="operator-online-btn" class="dropdown-item">${ASC.Resources.Master.Resource.OnlineStatus}<\/li><li id="operator-offline-btn" class="dropdown-item">${ASC.Resources.Master.Resource.OfflineStatus}<\/li><\/ul>');jQuery.template("options-box-tmpl",'<select id="call-type-selector" class="comboBox"><option value="2" class="browser-type-call" {{if answer== 2}} selected="selected" {{/if}}>${ASC.Resources.Master.TemplateResource.Browser}<\/option>{{each phones}}<option value="0" class="phone-type-call" data-number="${title}" {{if answer== 0 && redirectToNumber== title}} selected="selected" {{/if}}>${title}<\/option>{{/each}}<\/select><div id="toggle-missed-box-btn" class="disable"><div class="voip-missed"><\/div><\/div><div id="toggle-phone-box-btn" class="disable"><div class="voip-tastatura"><\/div><\/div>');jQuery.template("countries-panel-tmpl",'<div id="countries-panel" class="studio-action-panel"><ul class="dropdown-content">{{each countries}}<li class="dropdown-item"><span class="voip-flag ${iso}" data-iso="${iso}" data-code="${code}"><\/span>${title}<\/li>{{/each}}<\/ul><\/div>');jQuery.template("contact-phone-switcher-item-tmpl",'<li class="dropdown-item"><div class="data">${data}<\/div><div class="category">${categoryName}<\/div><\/li>');jQuery.template("missed-call-tmpl",'<div class="missed-call" data-number="${lastCall.from}"><div class="missed-call-avatar">{{if lastCall.contact != null}}<a href="${\'/products/crm/default.aspx?id=\' + lastCall.contact.id}" target="_blank"><img src="${lastCall.contact.smallFotoUrl}" alt="${lastCall.contact.displayName}" /><\/a>{{/if}}            {{if callsCount > 1}}<div class="missed-call-group-count">${callsCount}<\/div>{{/if}}<\/div><div class="missed-call-contact">{{if lastCall.contact && lastCall.contact.displayName}}<a href="${\'/products/crm/default.aspx?id=\' + lastCall.contact.id}" target="_blank" class="missed-call-name" title="${lastCall.contact.displayName}">${lastCall.contact.displayName}<\/a><div class="missed-call-number">${lastCall.from}<\/div>{{else}}<div class="missed-call-number-single">${lastCall.from}<\/div>{{/if}}<\/div><div class="recall-btn" data-number="${lastCall.from}"><div><\/div><\/div><div class="missed-call-date">${lastCall.time}<\/div><div class="missed-call-icon"><\/div><\/div>');jQuery.template("operators-redirect-option-tmpl",'<option value="${id}">${displayName}<\/option>');jQuery.template("call-tmpl",'{{if contact != null}}<div id="call-avatar"><a href="${\'/products/crm/default.aspx?id=\' + contact.id}" target="_blank"><img src="${contact.mediumFotoUrl}" alt="${contact.displayName}" /><\/a><\/div><div id="call-dude"><a href="${\'/products/crm/default.aspx?id=\' + contact.id}" target="_blank" id="dude-name">${contact.displayName}<\/a><div id="dude-company"><\/div><\/div>{{/if}}<div id="call-number"><div id="number-value">{{if status === 0 || status === 2}}${from}{{else}}${to}{{/if}}<\/div><div id="number-location"><\/div><\/div>');typeof ASC=="undefined"&&(ASC={});typeof ASC.Voip=="undefined"&&(ASC.Voip={});ASC.Voip.Countries=function(){function n(n,t,i){return{iso:n,title:t,code:i}}return[n("US","United States",1),n("AT","Austria",43),n("AU","Australia",61),n("BE","Belgium",32),n("BG","Bulgaria",359),n("CA","Canada",1),n("CH","Switzerland",41),n("CZ","Czech Republic",420),n("DK","Denmark",45),n("ES","Spain",34),n("FI","Finland",358),n("FR","France",33),n("GB","United Kingdom",44),n("GR","Greece",30),n("HK","Hong Kong",852),n("IE","Ireland",353),n("IL","Israel",972),n("IT","Italy",39),n("JP","Japan",81),n("LV","Latvia",371),n("MX","Mexico",52),n("NL","The Netherlands",31),n("NZ","New Zealand",64),n("PL","Poland",48),n("PR","Puerto Rico",1787),n("PT","Portugal",351),n("RO","Romania",40),n("SE","Sweden",46),n("SK","Slovakia",421)]}();typeof ASC=="undefined"&&(ASC={});typeof ASC.CRM=="undefined"&&(ASC.CRM=function(){return{}});typeof ASC.CRM.Voip=="undefined"&&(ASC.CRM.Voip=function(){return{}});ASC.CRM.Voip.PhoneView=function(n){function nf(){if(ASC.SocketIO&&!ASC.SocketIO.disabled()&&(p=ASC.SocketIO.Factory.voip),typeof p=="undefined"){n(".studio-top-panel .voip").hide();return}document.addEventListener("visibilitychange",function(){li=document.hidden},!1);uf();ff();ef();uu();p.on("reconnecting",function(){pi(r.offline);Twilio.Device.destroy()}).on("disconnected",function(){y&&(pi(r.offline),Twilio.Device.destroy())}).connect(function(){of(tf)}).reconnect_failed(function(){ri=!0;o()}).on("status",pi).on("miss",le).on("onlineAgents",oe).on("dequeue",se)}function tf(n){sf(n);p.emit("getStatus",function(n){t.status=n;n!=r.offline&&(ht=!0);o();n===r.offline&&vi(r.online)})}function rf(n){Teamlab.getVoipToken(null,{success:function(t,i){Twilio.Device.setup(i);Twilio.Device.ready(function(){Twilio.Device.sounds.incoming(!1);Twilio.Device.sounds.disconnect(!0);Twilio.Device.incoming(function(n){ve(n)});Twilio.Device.cancel(ye);Twilio.Device.error(function(n){n&&(n.code===31201||n.code===31208)&&yu()});Twilio.Device.offline(function(){y=!1;ot=null});y=!0;fu(n)})}})}function uf(){tr=n(".voipActiveBox");dt=n("#studio_dropVoipPopupPanel");l=dt.find("#voip-phone-view");ir="operator-status-switcher-options-tmpl";rr="options-box-tmpl";ur="countries-panel-tmpl";fr="contact-phone-switcher-item-tmpl";fi="missed-call-tmpl";er="operators-redirect-option-tmpl";or="call-tmpl";c=dt.find("#incoming-player").get(0);be()?c.src="https://media.twiliocdn.com/sdk/js/client/sounds/releases/1.0.0/incoming.mp3":ke()?c.src=nu.VoipPhone.IncomingRingtoneWav:c=null;sr=l.find("#service-unavailable-box");ei=l.find("#service-already-running-box");hr=l.find("#view-init-loader-box");d=l.find("#operator-box");gt=d.find("#operator-status");cr=d.find("#operator-name");a=d.find("#operator-status-switcher");ni=d.find("#operator-status-switcher-options");s=l.find("#options-box");tt=l.find("#missed-calls-box");it=l.find("#missed-calls-list");ti=tt.find("#missed-calls-empty-msg");v=l.find("#phone-box");oi=v.find("#selected-contact");w=v.find("#phone-selector-box");lr=w.find("#country-selector");b=w.find("#phone-input");g=w.find("#phone-clear-btn");si=w.find("#contact-phone-switcher-btn");ar=w.find("#contact-phone-switcher-panel");ii=v.find("#select-contact-btn");nt=v.find("#call-btn");e=l.find("#call-box");vr=e.find("#call-status-box");yr=vr.find(".call-status");pr=e.find("#call-main-box");gu=e.find("#call-dude");hi=e.find("#call-timer");wr=e.find(".call-btn");br=e.find(".answer-btn");kr=e.find(".reject-btn");dr=e.find(".complete-btn");lt=e.find(".redirect-btn");at=e.find("#operators-redirect-box");vt=at.find("#operators-redirect-selector");ci=at.find("#operators-redirect-empty-msg")}function ff(){var n="click";d.on(n,"#operator-online-btn",vi.bind(this,0));d.on(n,"#operator-offline-btn",vi.bind(this,2));a.on(n,kf);s.on("change","#call-type-selector",df);v.on(n,".panel-btn",te);b.on("keyup",cu);g.on(n,yi);w.on(n,"#countries-panel .dropdown-item",gf);w.on(n,"#contact-phone-switcher-panel .dropdown-item",ne);ii.on("showList",su);tt.on(n,".recall-btn",re);nt.on(n,ie);br.on(n,ue);kr.on(n,yu);dr.on(n,ee);lt.on(n,fe);s.on(n,"#toggle-phone-box-btn",eu);s.on(n,"#toggle-missed-box-btn",ou)}function ef(){n.dropdownToggle({switcherSelector:"#operator-status-switcher",dropdownID:"operator-status-switcher-options",addTop:-7,addLeft:9,inPopup:!0});n.dropdownToggle({switcherSelector:"#country-selector",dropdownID:"countries-panel",addTop:8,addLeft:10,inPopup:!0});n.dropdownToggle({switcherSelector:"#contact-phone-switcher-btn",dropdownID:"contact-phone-switcher-panel",addTop:18,addLeft:-207,inPopup:!0});ii.contactadvancedSelector({inPopup:!0,isTempLoad:!0,onechosen:!0,withPhoneOnly:!0})}function of(n){var t=function(n){return{success:function(t,i){n(null,i)},error:function(t){n(t)}}};async.parallel([function(n){Teamlab.getCrmCurrentVoipNumber(null,t(n))},function(n){Teamlab.getVoipMissedCalls(null,t(n))}],function(t,i){t?ft():n(i)})}function tu(n,t){var i;"Notification"in window&&(Notification.permission==="granted"?i=new Notification(t,{body:n}):Notification.permission!=="denied"&&Notification.requestPermission(function(r){r==="granted"&&(i=new Notification(t,{body:n}))}),i&&(i.onclick=function(n){n.preventDefault();window.focus()}))}function sf(n){var r,i,f,h,o,e,s;if("Notification"in window&&Notification.requestPermission(),yt=ASC.Voip.Countries,ct=Teamlab.profile,r=n[0],t=r.settings.caller,ui=r.settings.pause,pt=t.allowOutgoingCalls&&r.settings.allowOutgoingCalls,pt||au(),ai="+"+r.number,document.title=ai,i=n[1],i.length)for(u.push({lastCall:i[0],callsCount:1}),f=1;f<i.length;f++){for(h=i[f],o=!1,e=0;e<u.length;e++)if(s=u[e],s.lastCall.from==h.from){s.callsCount++;o=!0;break}o||u.push({lastCall:i[f],callsCount:1})}}function hf(n){var t=!1;return u.length&&u[0].lastCall.from==n.from?(t=!0,u[0].lastCall=n,u[0].callsCount++):u.unshift({lastCall:n,callsCount:1}),{repeatedCall:t,call:u[0]}}function cf(n){for(var i=[],t=0;t<u.length;t++)u[t].lastCall.from!=n&&i.push(u[t]);u=i}function lf(n){for(var t=UserManager.getUsers(n),i=0;i<t.length;i++)if(t[i].id==ct.id){t.splice(i,1);break}return t}function iu(n){for(var r,t=[],i=0;i<yt.length;i++)r=yt[i],n.indexOf("+"+r.code)==0&&t.push(r);if(t.length==0)return null;if(t.length==1)return t[0];for(i=0;i<t.length;i++)if(t[i].iso==gi)return t[i];return t[0]}function af(n){t.answer=n.answerType;t.redirectToNumber=n.redirectToNumber}function o(){if(hr.hide(),ri){sr.show();return}if(ht){ei.show();return}ei.hide();ru();vf();yf();pf();wf();i==f.incomingStarted&&bf()}function ru(){ni.html(jq.tmpl(ir));ni.hide();cr.text(ct.displayName);t.status==r.online?(gt.removeClass("offline").addClass("online"),a.text(rt.OnlineStatus),a.removeClass("lock")):t.status==r.offline?(gt.removeClass("online").addClass("offline"),a.text(rt.OfflineStatus),a.removeClass("lock")):t.status==r.busy&&(gt.removeClass("offline").addClass("online"),a.text(rt.BusyStatus),a.removeClass("lock"),i!=null&&a.addClass("lock"));d.show()}function vf(){var f,n,u;if(pt){if(i!=null){s.hide();return}f=jq.tmpl(rr,{answer:t.answer,redirectToNumber:t.redirectToNumber,phones:ct.contacts.telephones});s.html(f);n=s.find("#toggle-phone-box-btn");u=s.find("#toggle-missed-box-btn");t.answer==0?(n.hide(),u.hide()):(n.show(),u.show(),t.status===r.offline?(n.addClass(k),u.addClass(k)):(n.removeClass(k),u.removeClass(k)));s.show()}}function yf(){if(i!=null||v.is(":visible")){tt.hide();return}if((t.status==r.offline||t.answer==0?tt.hide():ou(),u.length?ti.hide():ti.show(),!y)&&u.length){ti.hide();var f=n.tmpl(fi,u);it.html(f)}}function pf(){if(!y){var u=n.tmpl(ur,{countries:yt});w.append(u)}if(t.status==r.offline||i!=null||t.answer==0){v.hide();return}}function wf(){if(i==null){e.hide();return}hi.empty();yr.hide().filter("[data-status="+i+"]").show();wr.hide().filter("[data-status="+i+"]").show();i==f.incomingGoing?at.show():at.hide();var t=n.tmpl(or,h);pr.html(t);e.show()}function bf(){dt.is(":visible")||tr.click()}function uu(){st();b.val(ki)}function st(n){var t=arguments.length==0?di:n;gi=t;lr.attr("class","voip-flag link arrow-down "+t)}function vi(n){t.status==n?ni.hide():(ku(),t.status===r.offline&&n===r.online?rf(n):(t.status===r.online&&n===r.offline&&Twilio.Device.destroy(),fu(n)))}function fu(n){p.emit("status",n,function(){bi()})}function kf(){return t.status==r.busy&&i!=null?!1:!0}function df(t){var u=n(t.target),i=n(t.target).val(),r=i=="0"?{answerType:i,redirectToNumber:u.find(":selected").attr("data-number")}:{answerType:i};ku();Teamlab.updateCrmVoipOperator(null,ct.id,r,{success:function(){bi();af(r);o()},error:function(){bi();ft()}})}function eu(){jq(this).hasClass(k)||(tt.hide(),e.hide(),v.show(),s.find("#toggle-missed-box-btn").removeClass(kt),s.find("#toggle-phone-box-btn").addClass(kt))}function ou(){jq(this).hasClass(k)||(e.hide(),v.hide(),tt.show(),s.find("#toggle-phone-box-btn").removeClass(kt),s.find("#toggle-missed-box-btn").addClass(kt))}function gf(t){var i=n(t.currentTarget).find(".voip-flag"),r=i.attr("data-iso"),u=i.attr("data-code");yi();r!=di?g.show():g.hide();st(r);b.val("+"+u);i.closest(".studio-action-panel").hide()}function ne(t){var i=n(t.currentTarget).find(".data"),r=i.text();hu(r);i.closest(".studio-action-panel").hide()}function su(n,t){var i,r;et=t;oi.text(t.title).show();i=t.phone[0].data;hu(i);r=jq.tmpl(fr,t.phone);ar.find(".dropdown-content").html(r);g.show();si.show()}function hu(n){var t=iu(n);t?st(t.iso):st();b.val(n)}function te(t){var i=n(t.currentTarget).attr("data-value"),r=b.val()+i;b.val(r);cu()}function cu(){var t=b.val().replace(/\D/g,""),n;t!=ki?g.show():g.hide();n=iu(t);n?st(n.iso):st();lu()}function yi(){uu();g.hide();lu()}function lu(){oi.hide();si.hide();et&&(ii.contactadvancedSelector("unselect",[et.id]),et=null)}function ie(){if(!nt.is(".disable")){nt.addClass("disable");var n={to:b.val().replace(/\D/g,""),contactId:et?et.id:null};Teamlab.callVoipNumber(null,n,{success:function(n,u){h=u;t.status=r.busy;i=f.outgoingStarted;nt.removeClass("disable");o()},error:function(n,t){Array.isArray(t)&&t.length?toastr.error(t[0]):ft();nt.removeClass("disable")}})}}function re(u){var e=n(u.currentTarget),s;e.is(".disable")||(e.addClass("disable"),e.closest(".missed-call").addClass("selected"),au(),s=e.attr("data-number"),Teamlab.callVoipNumber(null,{to:s},{success:function(n,u){h=u;t.status=r.busy;i=f.outgoingStarted;e.removeClass("disable");vu();o();cf(s);it.find('.missed-call[data-number="'+s+'"]').remove()},error:function(){e.removeClass("disable");e.closest(".missed-call").removeClass("selected");vu();ft()}}))}function au(){it.addClass("lock")}function vu(){pt&&it.removeClass("lock")}function ue(){Teamlab.answerVoipCall({},h.id,{error:function(){ft()}})}function yu(){Teamlab.rejectVoipCall({},h.id,{success:function(){i=f.incomingCompleted;o();ut()},error:function(){ft();ut()}})}function fe(){if(!lt.is(".disable")){var n=vt.val();Teamlab.redirectVoipCall({},h.id,{to:n},{success:function(){i=f.incomingCompleted;o();ut()},error:function(){ft();ut()}})}}function ee(){ot?ot.disconnect():(wi(),i=f.incomingCompleted,o(),ut())}function pu(n){if(!t||t.status!==r.online||i!==null||ri||ht){bt=n;return}bt=null;eu();Teamlab.getCrmContact({},n,{success:function(n,t){var i={title:t.displayName||t.title||t.name||t.Name,id:t.id&&t.id.toString(),phone:t.phone||t.commonData&&t.commonData.filter(function(n){return n.infoType==0})};t.hasOwnProperty("contactclass")&&(i.type=t.contactclass);su(undefined,i)}})}function pi(n){if(y||(t.status==r.offline&&n==r.online&&(ht=!0),n===r.offline&&(ht=!1)),t.status=n,t.status!=r.online?nt.addClass(k):nt.removeClass(k),t.status==r.busy){ru();return}o();bt&&pu(bt)}function oe(n){var t,i;y&&(t=lf(n),t&&t.length?(i=jq.tmpl(er,t),vt.html(i),lt.removeClass("disable"),ci.hide(),vt.show()):(vt.hide(),lt.addClass("disable"),ci.show()))}function se(n){y&&p.emit("status",1,function(){Teamlab.getVoipCall({},n,{success:function(n,t){if(h=t,i=f.incomingStarted,c&&c.play(),li){tu(t.from,rt.CallIncoming);var r=setInterval(function(){if(window.closed){clearInterval(r);return}document.title=rt.CallIncoming+":"+t.from;window.focus()},1e3);window.onmousemove=function(){clearInterval(r);document.title=ai;document.onmousemove=null}}o()}})})}function he(){if(i==f.incomingStarted)i=f.incomingGoing,wu();else if(i==f.outgoingStarted)i=f.outgoingGoing;else return;o();pe()}function ce(){if(wi(),ot&&ot.disconnect(),i==f.incomingGoing)i=f.incomingCompleted;else if(i==f.outgoingGoing)i=f.outgoingCompleted;else return;o();ut()}function le(n){y&&Teamlab.getVoipCall({},n,{success:function(n,t){var i=hf(t),r=jq.tmpl(fi,i.call);i.repeatedCall?it.find(".missed-call:first").replaceWith(r):it.prepend(r);ut(0);ui||p.emit("status",0);li&&tu(t.from,rt.CallMissed)}})}function ut(n){ae();var t=arguments.length==1?n:du;setTimeout(function(){o()},t)}function ae(){h=null;i=null;wu();a.removeClass("lock");yi()}function wu(){c&&c.readyState!=0&&(c.pause(),c.currentTime=0)}function ve(n){ot=n;n.accept(function(){p.emit("status",1);he();Teamlab.saveVoipCall({},h.id,{answeredBy:Teamlab.profile.id},{async:!0,success:function(n,t){h=t;o()}})});n.disconnect(function(){ui||p.emit("status",0);ce()});n.accept()}function ye(){wi()}function pe(){nr=Date.now();wt=setInterval(function(){we()},1e3)}function we(){var r=Date.now(),i=r-nr,n=~~(i/6e4),t=~~((i-n*6e4)/1e3);n=n/10<1?"0"+n:n;t=t/10<1?"0"+t:t;hi.text(n+":"+t)}function wi(){wt&&(clearInterval(wt),wt=null)}function be(){return bu("mp3")}function ke(){return bu("wav")}function bu(n){try{var t=document.createElement("audio");if(!!t.canPlayType)switch(n){case"ogg":return t.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,"");case"mp3":return t.canPlayType("audio/mpeg;").replace(/^no$/,"");case"wav":return t.canPlayType('audio/wav; codecs="1"').replace(/^no$/,"");case"m4a":return(t.canPlayType("audio/x-m4a;")||t.canPlayType("audio/aac;")).replace(/^no$/,"")}}catch(i){}return!1}function ku(){gr.displayLoading()}function bi(){gr.hideLoading()}function ft(){toastr.error(rt.CommonJSErrorMsg)}var y=!1,ri=!1,ht=!1,yt=[],ct=null,t=null,ui=!1,pt=!1,u=[],h=null,i=null,ki="+1",di="US",gi="US",et=null,c=null,du=5e3,wt=null,nr=null,p=null,ot=null,bt,k="disable",kt="active",tr,dt,l,ir,rr,ur,fr,fi,er,or,sr,ei,hr,d,gt,cr,a,ni,s,tt,it,ti,v,oi,w,lr,b,g,si,ar,ii,nt,e,vr,yr,pr,gu,hi,wr,br,kr,dr,lt,at,vt,ci,gr=LoadingBanner,nu=ASC.Resources.Master,rt=nu.Resource,r={online:0,busy:1,offline:2},f={outgoingStarted:0,outgoingGoing:1,outgoingCompleted:2,incomingStarted:3,incomingGoing:4,incomingCompleted:5},li=!0,ai;return{init:nf,makeCallToContact:pu}}(jq);jq(function(){ASC.CRM.Voip.PhoneView.init()})